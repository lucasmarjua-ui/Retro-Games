<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Retro Race</title>
<style>
  body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background-color: #e6d7be;
    font-family: 'Press Start 2P', monospace;
    color: #3b2d1f;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  canvas {
    background-color: #e6d7be;
    display: block;
    border: 6px solid #3b2d1f;
    border-radius: 12px;
    margin-top: 20px;
  }
  #ui {
    display: flex;
    justify-content: space-between;
    width: 500px;
    margin-top: 10px;
  }
  #startScreen, #gameOverScreen {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.7);
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
  }
  button {
    font-family: 'Press Start 2P', monospace;
    background-color: #dcbfa6;
    border: 3px solid #3b2d1f;
    color: #3b2d1f;
    padding: 10px 20px;
    border-radius: 10px;
    cursor: pointer;
  }
  button:hover {
    background-color: #f0d8ba;
  }
</style>
</head>
<body>
  <div id="ui">
    <div>PUNTOS: <span id="score">0</span></div>
    <div>MONEDAS: <span id="coins">0</span></div>
    <div>R√âCORD: <span id="record">0</span></div>
  </div>
  <canvas id="gameCanvas" width="400" height="600"></canvas>

  <div id="startScreen">
    <h1 style="font-size: 22px;">üèÅ RETRO RACE üèÅ</h1>
    <p>Pulsa INICIAR para empezar</p>
    <button id="startBtn">INICIAR</button>
  </div>

  <div id="gameOverScreen" style="display:none;">
    <h1>GAME OVER</h1>
    <p>Puntuaci√≥n: <span id="finalScore">0</span></p>
    <p>R√©cord: <span id="finalRecord">0</span></p>
    <button id="restartBtn">REINICIAR</button>
  </div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

const startScreen = document.getElementById("startScreen");
const gameOverScreen = document.getElementById("gameOverScreen");
const startBtn = document.getElementById("startBtn");
const restartBtn = document.getElementById("restartBtn");

const scoreEl = document.getElementById("score");
const coinsEl = document.getElementById("coins");
const recordEl = document.getElementById("record");
const finalScoreEl = document.getElementById("finalScore");
const finalRecordEl = document.getElementById("finalRecord");

let record = parseInt(localStorage.getItem("retroRaceRecord")) || 0;
recordEl.textContent = record;

let player, obstacles = [], coins = [];
let score = 0, coinCount = 0, speed = 2, playing = false;
let lanes = [];
let spawnTimer = 0, coinTimer = 0, elapsed = 0;
let safeStartTime = 0;


/* Sprites */
const carImg = new Image(); carImg.src = "sprites/player.png";
const car1Img = new Image(); car1Img.src = "sprites/car1.png";
const truckImg = new Image(); truckImg.src = "sprites/truck.png";

/* Sonidos */
const snd = {
  bg: new Audio("sounds/music.mp3"),
  coin: new Audio("sounds/coin.mp3"),
  crash: new Audio("sounds/crash.wav"),
  over: new Audio("sounds/gameover.mp3")
};
snd.bg.loop = true; snd.bg.volume = 0.3;

/* Inicializaci√≥n */
function initGame() {
  const left = canvas.width * 0.12;
  const roadWidth = canvas.width * 0.76;
  lanes = [left + roadWidth * 1/6, left + roadWidth * 3/6, left + roadWidth * 5/6];

  player = { lane: 1, x: lanes[1], y: canvas.height - 80, w: 50, h: 90, targetX: lanes[1] };
  obstacles = [];
  coins = [];
  score = 0;
  coinCount = 0;
  speed = 1;
  elapsed = 0;
  spawnTimer = 0;
  coinTimer = 0;
  safeStartTime = 2000; // 2 segundos de gracia
}

/* Dibujar carretera */
function drawRoad() {
  ctx.fillStyle = "#4a4a4a";
  ctx.fillRect(canvas.width*0.12, 0, canvas.width*0.76, canvas.height);
  ctx.strokeStyle = "rgba(255,255,255,0.3)";
  ctx.lineWidth = 2;
  ctx.setLineDash([12, 16]);
  for (let i = 1; i <= 2; i++) {
    const x = canvas.width * 0.12 + i * (canvas.width * 0.76) / 3;
    ctx.beginPath();
    ctx.moveTo(x, 0);
    ctx.lineTo(x, canvas.height);
    ctx.stroke();
  }
  ctx.setLineDash([]);
}

/* Dibujar jugador */
function drawPlayer() {
  player.x += (player.targetX - player.x) * 0.2;
  ctx.drawImage(carImg, player.x - player.w/2, player.y - player.h/2, player.w, player.h);
}

/* Generar obst√°culo */
function spawnObstacle() {
  const lane = Math.floor(Math.random() * 3);
  const type = Math.random() < 0.5 ? "car" : "truck";
  const img = type === "truck" ? truckImg : car1Img;
  const w = type === "truck" ? 70 : 60;
  const h = type === "truck" ? 110 : 80;
  const y = -h - 100;
  obstacles.push({ lane, x: lanes[lane], y, w, h, img });
}

/* Generar moneda */
function spawnCoin() {
  const lane = Math.floor(Math.random() * 3);
  coins.push({ lane, x: lanes[lane], y: -50 });
}

/* Actualizar */
function update(dt) {
  elapsed += dt;
  if (safeStartTime > 0) { safeStartTime -= dt; return; }

  spawnTimer += dt;
  coinTimer += dt;

  if (spawnTimer > 1000) {
    spawnObstacle();
    spawnTimer = 0;
  }
  if (coinTimer > 1500) {
    spawnCoin();
    coinTimer = 0;
  }

  // Aumentar dificultad poco a poco
  if (elapsed % 5000 < 16) speed += 0.1;

  for (const o of obstacles) o.y += speed * 3;
  for (const c of coins) c.y += speed * 3;

  obstacles = obstacles.filter(o => o.y < canvas.height + 100);
  coins = coins.filter(c => c.y < canvas.height + 50);

  // Colisiones
  for (const o of obstacles) {
    if (Math.abs(player.x - o.x) < 40 && Math.abs(player.y - o.y) < 70) {
      gameOver();
      return;
    }
  }

  for (let i = coins.length - 1; i >= 0; i--) {
    const c = coins[i];
    if (Math.abs(player.x - c.x) < 40 && Math.abs(player.y - c.y) < 60) {
      coins.splice(i, 1);
      coinCount++;
      score += 150;
      snd.coin.currentTime = 0;
      snd.coin.play();
    }
  }

  score += dt * 0.02;
  scoreEl.textContent = Math.floor(score);
  coinsEl.textContent = coinCount;
}

/* Renderizar */
function render() {
  ctx.fillStyle = "#e6d7be";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  drawRoad();

  for (const o of obstacles) ctx.drawImage(o.img, o.x - o.w/2, o.y, o.w, o.h);
  ctx.font = "40px Arial";
  for (const c of coins) ctx.fillText("üí∞", c.x - 20, c.y);
  drawPlayer();
}

/* Game Over */
function gameOver() {
  playing = false;
  snd.bg.pause();
  snd.crash.currentTime = 0; snd.crash.play();
  snd.over.play();
  gameOverScreen.style.display = "flex";
  finalScoreEl.textContent = Math.floor(score);
  if (score > record) {
    record = Math.floor(score);
    localStorage.setItem("retroRaceRecord", record);
  }
  finalRecordEl.textContent = record;
}

/* Bucle */
let lastTime = 0;
function loop(time) {
  if (!playing) return;
  const dt = time - lastTime;
  lastTime = time;
  update(dt);
  render();
  requestAnimationFrame(loop);
}

/* Iniciar juego */
function startGame() {
  initGame();
  startScreen.style.display = "none";
  gameOverScreen.style.display = "none";
  snd.bg.currentTime = 0;
  snd.bg.play().catch(()=>{});
  playing = true;
  requestAnimationFrame(loop);
}

/* Reiniciar */
restartBtn.onclick = startGame;
startBtn.onclick = startGame;

/* Controles */
window.addEventListener("keydown", e => {
  if (!playing) return;

  // Movimiento lateral entre carriles
  if (e.key === "ArrowLeft" && player.lane > 0) player.lane--;
  else if (e.key === "ArrowRight" && player.lane < 2) player.lane++;
  player.targetX = lanes[player.lane];

  // Movimiento vertical
  const topLimit = 80; // margen superior visual
  const bottomLimit = canvas.height - player.height - 5; // l√≠mite inferior exacto

  if (e.key === "ArrowUp") {
    player.y -= 25;
    if (player.y < topLimit) player.y = topLimit;
  } 
  else if (e.key === "ArrowDown") {
    player.y += 25;
    if (player.y > bottomLimit) player.y = bottomLimit;
  }
});


</script>
</body>
</html>
