<!-- =========================
     ARCADE AWARDS - CLIENT
     Pegar dentro de tu p치gina (index.html)
     Reemplaza SUPABASE_URL y SUPABASE_ANON_KEY
   ========================= -->
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
/* Estilo simple retro para el panel de logros / leaderboard */
#arcadeAwards {
  position: fixed;
  right: 18px;
  bottom: 18px;
  width: 320px;
  background:#f5e6d3;
  border:4px solid #a0522d;
  padding:12px;
  border-radius:10px;
  font-family:'Press Start 2P', monospace;
  z-index: 99999;
  box-shadow: 0 8px 20px rgba(0,0,0,0.4);
}
#arcadeAwards h3{margin:0 0 8px 0; font-size:12px}
#arcadeAwards button{font-family:'Press Start 2P'; margin:4px 0; width:100%}
#aaLeaderboard { max-height:220px; overflow:auto; margin-top:8px; font-size:11px; background:#fff3e0; padding:8px; border-radius:8px; border:2px solid #d9b38c;}
.aaEntry{padding:6px;border-bottom:1px solid rgba(0,0,0,0.05); display:flex; justify-content:space-between}
.achievement-popup {
  position: fixed;
  left: 50%;
  top: 10%;
  transform: translateX(-50%);
  background:#ffdca8;
  color:#2b2b2b;
  border:3px solid #a0522d;
  padding:12px 18px;
  border-radius:10px;
  z-index: 100000;
  font-family:'Press Start 2P';
  text-align:center;
  box-shadow:0 10px 20px rgba(0,0,0,0.3);
}
</style>

<div id="arcadeAwards">
  <h3>游끥 Arcade Awards</h3>
  <div id="aaUserArea">
    <input id="aaName" placeholder="Tu nombre" style="width:100%; font-family:'Press Start 2P'; padding:8px; font-size:12px" />
    <button id="aaLoginBtn">Entrar</button>
  </div>

  <div id="aaControls" style="display:none">
    <div style="font-size:11px">Usuario: <strong id="aaUserLabel"></strong></div>
    <button id="aaSyncBtn">Sincronizar logros</button>
    <button id="aaShowLeaderboardBtn">Mostrar leaderboard (Space Invaders)</button>
    <div id="aaLeaderboardContainer" style="display:none">
      <div id="aaLeaderboardTitle" style="font-size:11px; margin-top:6px">Top 10</div>
      <div id="aaLeaderboard" class="aaLeaderboard"></div>
    </div>
  </div>
</div>

<!-- Popup container -->
<div id="aaPopupRoot"></div>

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>

<script>
/* ========== CONFIG: Rellena con tus datos de Supabase ========== */
const SUPABASE_URL = "https://TU-PROJECT.supabase.co"; // <- reemplaza
const SUPABASE_ANON_KEY = "pk.anon.xxx...";            // <- reemplaza
/* ============================================================= */

const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// --- Util UUID simple
function uuidv4(){
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = (Math.random() * 16) | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

// --- Local storage keys
const LS_USER = 'arcadeAwards_user_v1';
const LS_ACH = 'arcadeAwards_localAchievements_v1';

// --- Achievements definitions (personaliza)
const ACHIEVEMENTS = [
  { id: 'pinball_5000', name:'游꿢 Maestro del rebote', game:'pinball', condition:'score>=5000' },
  { id: 'snake_30', name:'游냀 Serpiente XXL', game:'snake', condition:'length>=30' },
  { id: 'space_triple', name:'游눤 Triple Kill', game:'space', condition:'triple_kill' },
  { id: 'whac_fast100', name:'游댣 Velocidad suprema', game:'whac', condition:'score>=100' },
  // a침ade m치s seg칰n tus juegos...
];

// --- Estado
let currentUser = null;
let localAchievements = {}; // {achievementId: true}

// --- Init UI
document.addEventListener('DOMContentLoaded', () => {
  // load user
  const saved = localStorage.getItem(LS_USER);
  if(saved) {
    currentUser = JSON.parse(saved);
    showLoggedInUI();
  }

  const savedAch = localStorage.getItem(LS_ACH);
  if(savedAch) localAchievements = JSON.parse(savedAch) || {};

  // UI bindings
  document.getElementById('aaLoginBtn').addEventListener('click', () => {
    const name = document.getElementById('aaName').value.trim();
    if(!name) return alert('Escribe tu nombre');
    loginWithName(name);
  });

  document.getElementById('aaSyncBtn').addEventListener('click', uploadLocalAchievements);
  document.getElementById('aaShowLeaderboardBtn').addEventListener('click', () => {
    // cambia el game aqu칤 seg칰n lo que quieras mostrar
    fetchLeaderboard('space').then(() => {
      document.getElementById('aaLeaderboardContainer').style.display='block';
    });
  });
});

// --- Login simple con nombre (genera uuid si es nuevo)
function loginWithName(username) {
  let user = localStorage.getItem(LS_USER);
  if(user) { user = JSON.parse(user); }
  if(!user) {
    user = { id: uuidv4(), username: username };
  } else {
    // actualizar nombre si cambia
    user.username = username;
  }
  currentUser = user;
  localStorage.setItem(LS_USER, JSON.stringify(user));
  // crear/asegurar registro en tabla users (no cr칤tico si falla)
  supabase.from('users').upsert({ id: user.id, username: user.username }).then(()=>{});
  showLoggedInUI();
}

function showLoggedInUI(){
  document.getElementById('aaUserArea').style.display='none';
  document.getElementById('aaControls').style.display='block';
  document.getElementById('aaUserLabel').textContent = currentUser.username;
}

// --- Unlock achievement locally + popup + store locally
function unlockAchievement(achievementId) {
  if(localAchievements[achievementId]) return; // ya desbloqueado
  const def = ACHIEVEMENTS.find(a => a.id === achievementId);
  if(!def) return;
  localAchievements[achievementId] = true;
  localStorage.setItem(LS_ACH, JSON.stringify(localAchievements));
  showAchievementPopup(def.name);
  // subir a supabase autom치ticamente si el usuario est치 logueado
  if(currentUser) {
    supabase.from('achievements').insert([{
      user_id: currentUser.id,
      username: currentUser.username,
      achievement_id: def.id,
      achievement_name: def.name,
      game: def.game
    }]).then(({error}) => {
      if(error) console.warn('Error subiendo achievement:', error.message);
    });
  }
}

// --- Popup
function showAchievementPopup(text) {
  const root = document.getElementById('aaPopupRoot');
  const el = document.createElement('div');
  el.className = 'achievement-popup';
  el.innerHTML = `<div style="font-size:12px">${text}</div><div style="font-size:10px;margin-top:6px">LOGRO DESBLOQUEADO</div>`;
  root.appendChild(el);
  setTimeout(()=> {
    el.style.transition='opacity 0.4s';
    el.style.opacity='0';
    setTimeout(()=>el.remove(),450);
  }, 2500);
}

// --- subir logros locales pendientes (en LS) a Supabase
async function uploadLocalAchievements(){
  if(!currentUser) return alert('Entra con tu nombre primero');
  const toUpload = [];
  for(const achId of Object.keys(localAchievements)){
    // podemos comprobar si ya existe en la tabla para evitar duplicados; pero por simplicidad intentamos insertar
    const def = ACHIEVEMENTS.find(a=>a.id===achId);
    if(def) toUpload.push({
      user_id: currentUser.id,
      username: currentUser.username,
      achievement_id: def.id,
      achievement_name: def.name,
      game: def.game
    });
  }
  if(toUpload.length===0) return alert('Sin logros nuevos para sincronizar');
  const { data, error } = await supabase.from('achievements').insert(toUpload);
  if(error) return alert('Error subiendo logros: ' + error.message);
  alert('Logros sincronizados correctamente');
}

// --- Enviar puntuaci칩n al leaderboard global
async function submitScore(game, score, metadata = {}) {
  if(!currentUser) {
    // si no hay user, guardarlo localmente y p칤deles entrar
    alert('Entrar con tu nombre para guardar puntuaciones en el ranking global.');
    return;
  }
  const { data, error } = await supabase.from('scores').insert([{
    user_id: currentUser.id,
    username: currentUser.username,
    game,
    score,
    metadata
  }]);
  if(error) console.warn('Error submitScore:', error.message);
  return data;
}

// --- Obtener top 10 de un juego
async function fetchLeaderboard(game) {
  const container = document.getElementById('aaLeaderboard');
  container.innerHTML = 'Cargando...';
  const { data, error } = await supabase
    .from('scores')
    .select('username, score, created_at')
    .eq('game', game)
    .order('score', { ascending: false })
    .limit(10);
  if(error) {
    container.innerHTML = 'Error: ' + error.message;
    return;
  }
  container.innerHTML = '';
  (data||[]).forEach((row, i) => {
    const div = document.createElement('div');
    div.className='aaEntry';
    div.innerHTML = `<div style="opacity:0.9">${i+1}. ${escapeHtml(row.username)}</div><div>${row.score}</div>`;
    container.appendChild(div);
  });
}

// small escaper
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
}

/* ============================
  HOW TO USE (instructions for your existing games)
   - When a player gets a score in any game, call:
       submitScore('pinball', 12345)
   - When a player achieves a defined achievement, call:
       unlockAchievement('pinball_5000')
   - To show leaderboard UI, press 'Mostrar leaderboard' button
   - To sync local achievements to server, press 'Sincronizar logros'
   ============================ */
</script>
